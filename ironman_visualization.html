<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Average Overall Time by Gender</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      body {
        font-family: sans-serif;
      }
      .bar {
        fill: steelblue;
      }
      .bar:hover {
        fill: orange;
      }
      .label {
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div style="margin: 40px 0 20px 50px">
      <button id="toggleSelect">Change Athlete (Chart 1)</button>
      <select id="athleteSelect" style="display: none"></select>
    </div>

    <svg id="chart1" width="600" height="400"></svg>

    <script>
      const file = "ironman.csv";
      const athleteName = "Reed, Tim";

      function hmsToSeconds(t) {
        if (!t) return null;
        const [h, m, s] = t.split(":").map(Number);
        return (h || 0) * 3600 + (m || 0) * 60 + (s || 0);
      }
      function secondsToHMS(sec) {
        const s = Math.round(sec);
        const h = Math.floor(s / 3600);
        const m = Math.floor((s % 3600) / 60);
        const ss = s % 60;
        return `${h}:${String(m).padStart(2, "0")}:${String(ss).padStart(
          2,
          "0"
        )}`;
      }

      d3.csv(file).then((data) => {
        // Build unique, sorted list of names for the dropdown
        const names = Array.from(new Set(data.map((d) => d.Name))).sort(
          d3.ascending
        );

        // Populate the (hidden) select
        const select = d3.select("#athleteSelect");
        select
          .selectAll("option")
          .data(names)
          .enter()
          .append("option")
          .attr("value", (d) => d)
          .text((d) => d);

        // Default selection (keep your current athleteName if present)
        const defaultName = names.includes(athleteName)
          ? athleteName
          : names[0];
        select.property("value", defaultName);

        // Toggle button shows/hides the select
        d3.select("#toggleSelect").on("click", () => {
          const cur = select.style("display");
          select.style("display", cur === "none" ? "inline-block" : "none");
        });

        const svg = d3.select("#chart1");
        const margin = { top: 30, right: 30, bottom: 70, left: 110 };
        const width = +svg.attr("width") - margin.left - margin.right;
        const height = +svg.attr("height") - margin.top - margin.bottom;

        const g = svg
          .append("g")
          .attr("transform", `translate(${margin.left},${margin.top})`);

        const x = d3.scaleBand().range([0, width]).padding(0.35);
        const y = d3.scaleLinear().range([height, 0]);

        const xAxisG = g
          .append("g")
          .attr("transform", `translate(0,${height})`);
        const yAxisG = g.append("g");

        // Titles/axis labels
        const title1 = svg
          .append("text")
          .attr("x", margin.left + width / 2)
          .attr("y", margin.top)
          .attr("text-anchor", "middle")
          .style("font-weight", 600);

        svg
          .append("text")
          .attr("x", margin.left + width / 2)
          .attr("y", margin.top + height + 50)
          .attr("text-anchor", "middle")
          .text("Split");

        svg
          .append("text")
          .attr(
            "transform",
            `translate(${margin.left - 80}, ${
              margin.top + height / 2
            }) rotate(-90)`
          )
          .attr("text-anchor", "middle")
          .text("Time (H:MM:SS)");

        // Render/Update function
        function renderAthlete(name) {
          const row = data.find((d) => d.Name === name);
          if (!row) return;

          const barData = [
            {
              category: "Swim",
              value: hmsToSeconds(row.Swim),
              label: row.Swim,
            },
            {
              category: "Bike",
              value: hmsToSeconds(row.Bike),
              label: row.Bike,
            },
            { category: "Run", value: hmsToSeconds(row.Run), label: row.Run },
            {
              category: "Overall",
              value: hmsToSeconds(row.Overall),
              label: row.Overall,
            },
          ].filter((d) => d.value != null);

          // update scales
          x.domain(barData.map((d) => d.category));
          y.domain([0, d3.max(barData, (d) => d.value)]).nice();

          // bars (data join with key = category)
          const bars = g.selectAll("rect.bar").data(barData, (d) => d.category);

          bars
            .enter()
            .append("rect")
            .attr("class", "bar")
            .attr("x", (d) => x(d.category))
            .attr("y", y(0))
            .attr("width", x.bandwidth())
            .attr("height", 0)
            .merge(bars)
            .transition()
            .duration(400)
            .attr("x", (d) => x(d.category))
            .attr("y", (d) => y(d.value))
            .attr("width", x.bandwidth())
            .attr("height", (d) => height - y(d.value));

          bars.exit().remove();

          // labels above bars
          const labels = g
            .selectAll("text.label")
            .data(barData, (d) => d.category);

          labels
            .enter()
            .append("text")
            .attr("class", "label")
            .attr("text-anchor", "middle")
            .attr("x", (d) => x(d.category) + x.bandwidth() / 2)
            .attr("y", y(0) - 6)
            .text((d) => d.label)
            .merge(labels)
            .transition()
            .duration(400)
            .attr("x", (d) => x(d.category) + x.bandwidth() / 2)
            .attr("y", (d) => y(d.value) - 6)
            .text((d) => d.label ?? "");

          labels.exit().remove();

          // axes
          xAxisG.transition().duration(400).call(d3.axisBottom(x));
          yAxisG
            .transition()
            .duration(400)
            .call(d3.axisLeft(y).tickFormat(secondsToHMS));

          // title
          title1.text(`${name} â€” Split vs Overall`);
        }

        // initial render
        renderAthlete(defaultName);

        // Dropdown change handler (also hide after pick)
        select.on("change", function () {
          renderAthlete(this.value);
          select.style("display", "none");
        });

        // Scatter: Bike vs Run
        const svg2 = d3
          .select("body")
          .append("svg")
          .attr("width", 700)
          .attr("height", 460);

        const margin2 = { top: 30, right: 30, bottom: 70, left: 100 };
        const width2 = 700 - margin2.left - margin2.right;
        const height2 = 460 - margin2.top - margin2.bottom;

        const g2 = svg2
          .append("g")
          .attr("transform", `translate(${margin2.left},${margin2.top})`);

        // Build dataset: numeric seconds + simple gender tag for color
        const runners = data
          .map((d) => ({
            Bike: hmsToSeconds(d.Bike),
            Run: hmsToSeconds(d.Run),
          }))
          .filter((d) => d.Bike != null && d.Run != null);

        // Scales
        const x2 = d3
          .scaleLinear()
          .domain(d3.extent(runners, (d) => d.Bike))
          .nice()
          .range([0, width2]);

        const y2 = d3
          .scaleLinear()
          .domain(d3.extent(runners, (d) => d.Run))
          .nice()
          .range([height2, 0]);

        // Axes
        g2.append("g")
          .attr("transform", `translate(0,${height2})`)
          .call(d3.axisBottom(x2).tickFormat(secondsToHMS));

        g2.append("g").call(d3.axisLeft(y2).tickFormat(secondsToHMS));

        // Points (circles)
        g2.selectAll("circle")
          .data(runners)
          .enter()
          .append("circle")
          .attr("cx", (d) => x2(d.Bike))
          .attr("cy", (d) => y2(d.Run))
          .attr("r", 3)
          .attr("opacity", 0.6)
          .attr("fill", "#1f77b4");

        // Axis labels & title
        svg2
          .append("text")
          .attr("x", margin2.left + width2 / 2)
          .attr("y", margin2.top - 10)
          .attr("text-anchor", "middle")
          .style("font-weight", 600)
          .text("Bike Time vs Run Time (All Athletes)");

        svg2
          .append("text")
          .attr("x", margin2.left + width2 / 2)
          .attr("y", margin2.top + height2 + 50)
          .attr("text-anchor", "middle")
          .text("Bike time (H:MM:SS)");

        svg2
          .append("text")
          .attr(
            "transform",
            `translate(${margin2.left - 70}, ${
              margin2.top + height2 / 2
            }) rotate(-90)`
          )
          .attr("text-anchor", "middle")
          .text("Run time (H:MM:SS)");

        // Bar Chart: Avg Overall Time by Division & Gender
        const svg3 = d3
          .select("body")
          .append("svg")
          .attr("width", 900)
          .attr("height", 500);

        const margin3 = { top: 40, right: 30, bottom: 140, left: 120 };
        const width3 = 900 - margin3.left - margin3.right;
        const height3 = 500 - margin3.top - margin3.bottom;

        const g3 = svg3
          .append("g")
          .attr("transform", `translate(${margin3.left},${margin3.top})`);

        // Helpers
        function divisionSortKey(div) {
          const d = (div ?? "").toUpperCase().trim();
          if (d === "MPRO") return { pro: 0, gender: "M", age: 0 };
          if (d === "FPRO") return { pro: 0, gender: "F", age: 0 };
          const m = d.match(/^([MF])(\d+)-/); // e.g., M25-29
          if (m) return { pro: 1, gender: m[1], age: +m[2] };
          return { pro: 2, gender: "Z", age: 999 }; // fallback
        }

        data.forEach((d) => {
          d._overallSec = hmsToSeconds(d.Overall);
          const g = (d.Gender ?? "").toString().trim().toUpperCase();
          d._G = g.startsWith("F") ? "F" : g.startsWith("M") ? "M" : null;
        });

        const grouped = d3.rollups(
          data.filter((d) => d._overallSec != null && d._G),
          (v) => d3.mean(v, (d) => d._overallSec),
          (d) => d.Division,
          (d) => d._G
        );

        // Sort divisions: Pro first, then age group from youngest to oldest + Male/Female
        let barData3 = [];
        grouped.forEach(([division, genders]) => {
          genders.forEach(([g, avg]) => {
            barData3.push({
              Division: division,
              Gender: g === "M" ? "Male" : "Female",
              value: avg,
            });
          });
        });

        const divisions = Array.from(
          new Set(barData3.map((d) => d.Division))
        ).sort((a, b) => {
          const ka = divisionSortKey(a);
          const kb = divisionSortKey(b);
          if (ka.pro !== kb.pro) return ka.pro - kb.pro;
          if (ka.age !== kb.age) return ka.age - kb.age;
          if (ka.gender !== kb.gender)
            return ka.gender.localeCompare(kb.gender);
          return 0;
        });

        // Scales
        const x0 = d3
          .scaleBand()
          .domain(divisions)
          .range([0, width3])
          .paddingInner(0.2);

        const x1 = d3
          .scaleBand()
          .domain(["Male", "Female"])
          .range([0, x0.bandwidth()])
          .padding(0.05);

        const y3 = d3
          .scaleLinear()
          .domain([0, d3.max(barData3, (d) => d.value)])
          .nice()
          .range([height3, 0]);

        const color = d3
          .scaleOrdinal()
          .domain(["Male", "Female"])
          .range(["#1f77b4", "#e377c2"]);

        // Bars
        g3.selectAll("g.division")
          .data(divisions)
          .enter()
          .append("g")
          .attr("class", "division")
          .attr("transform", (d) => `translate(${x0(d)},0)`)
          .selectAll("rect")
          .data((d) => barData3.filter((b) => b.Division === d))
          .enter()
          .append("rect")
          .attr("x", (d) => x1(d.Gender))
          .attr("y", (d) => y3(d.value))
          .attr("width", x1.bandwidth())
          .attr("height", (d) => height3 - y3(d.value))
          .attr("fill", (d) => color(d.Gender));

        // Axes
        g3.append("g")
          .attr("transform", `translate(0,${height3})`)
          .call(d3.axisBottom(x0))
          .selectAll("text")
          .attr("transform", "rotate(-45)")
          .style("text-anchor", "end");

        g3.append("g").call(d3.axisLeft(y3).tickFormat(secondsToHMS));

        // Titles
        svg3
          .append("text")
          .attr("x", margin3.left + width3 / 2)
          .attr("y", margin3.top - 15)
          .attr("text-anchor", "middle")
          .style("font-weight", 600)
          .text(
            "Average Overall Finish Time by Division & Gender (Pro first, then Age Group)"
          );

        svg3
          .append("text")
          .attr("x", margin3.left + width3 / 2)
          .attr("y", margin3.top + height3 + 90)
          .attr("text-anchor", "middle")
          .text("Division (Age Group)");

        svg3
          .append("text")
          .attr(
            "transform",
            `translate(${margin3.left - 80}, ${
              margin3.top + height3 / 2
            }) rotate(-90)`
          )
          .attr("text-anchor", "middle")
          .text("Average Overall Time (H:MM:SS)");

        // Legend
        const legend = svg3
          .append("g")
          .attr(
            "transform",
            `translate(${margin3.left + width3 / 2 - 100}, ${
              margin3.top + height3 + 80
            })`
          );

        ["Male", "Female"].forEach((gender, i) => {
          legend
            .append("rect")
            .attr("x", i * 100)
            .attr("y", -30)
            .attr("width", 15)
            .attr("height", 15)
            .attr("fill", color(gender));

          legend
            .append("text")
            .attr("x", i * 100 + 20)
            .attr("y", -18)
            .text(gender)
            .style("alignment-baseline", "middle");
        });
      });
    </script>
  </body>
</html>
